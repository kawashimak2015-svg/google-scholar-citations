name: Update Google Scholar Citations Badge

on:
  schedule:
    - cron: "0 3 * * *"   # daily. Much less likely to trigger blocking
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Fetch citations and write scholar-badge.json (retry + do-not-fail)
        run: |
          python - <<'PY'
          import json, os, random, re, time
          import requests
          from bs4 import BeautifulSoup

          PROFILE_URL = "https://scholar.google.com/citations?user=RqHme84AAAAJ&hl=en"
          OUTFILE = "scholar-badge.json"

          def fetch_citations(url: str) -> int:
              headers = {
                  "User-Agent": (
                      "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 "
                      "(KHTML, like Gecko) Chrome/120.0 Safari/537.36"
                  ),
                  "Accept-Language": "en-US,en;q=0.9",
              }
              r = requests.get(url, headers=headers, timeout=30)
              r.raise_for_status()
              html = r.text.lower()

              # If Scholar blocks automation, we usually see these hints.
              if "unusual traffic" in html or "captcha" in html:
                  raise RuntimeError("Blocked by Google Scholar (CAPTCHA/unusual traffic).")

              soup = BeautifulSoup(r.text, "lxml")

              # Citations table: first row is "Citations"
              first_row = soup.select_one("#gsc_rsb_st tr")
              if not first_row:
                  raise RuntimeError("Could not find citations stats table.")

              m = re.search(r"\b(\d{1,3}(?:,\d{3})*|\d+)\b", first_row.get_text(" ", strip=True))
              if not m:
                  raise RuntimeError("Could not parse citation number.")
              return int(m.group(1).replace(",", ""))

          citations = None
          last_err = None

          for attempt in range(1, 6):
              try:
                  # Small random delay reduces “bot-like” behavior
                  time.sleep(random.uniform(1, 4) * attempt)
                  citations = fetch_citations(PROFILE_URL)
                  break
              except Exception as e:
                  last_err = e
                  print(f"Attempt {attempt}/5 failed: {type(e).__name__}: {e}")
                  time.sleep(15 * attempt)

          if citations is None:
              # IMPORTANT: don't fail the workflow if we already have a previous badge.
              if os.path.exists(OUTFILE):
                  print(f"WARNING: Could not update citations this run ({last_err}). Keeping existing {OUTFILE}.")
                  raise SystemExit(0)
              else:
                  print(f"ERROR: Could not fetch citations and no existing {OUTFILE} found. ({last_err})")
                  raise SystemExit(1)

          data = {
              "schemaVersion": 1,
              "label": "Citations",
              "message": str(citations),
              "color": "blue"
          }

          with open(OUTFILE, "w", encoding="utf-8") as f:
              json.dump(data, f)

          print("Updated scholar-badge.json:", data)
          PY

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add scholar-badge.json
          git commit -m "Update Scholar citations badge" || exit 0
          git push
