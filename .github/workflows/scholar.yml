name: Update Google Scholar Citations

on:
  schedule:
    - cron: "0 2 * * *"   # daily
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install gsbg requests beautifulsoup4 lxml

      - name: Generate Shields endpoint JSON
        env:
          PROFILE_URL: "https://scholar.google.com/citations?user=RqHme84AAAAJ&hl=en"
        run: |
          python - <<'PY'
          import json, os, re, sys
          import requests
          from bs4 import BeautifulSoup

          profile_url = os.environ["PROFILE_URL"]

          def fetch_with_gsbg(url: str) -> int:
              import gsbg
              # Official usage in gsbg docs uses fetch_profile_citation_num(profile_link). :contentReference[oaicite:1]{index=1}
              return int(gsbg.fetch_profile_citation_num(url))

          def fetch_with_html_parse(url: str) -> int:
              headers = {
                  "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36",
                  "Accept-Language": "en-US,en;q=0.9",
              }
              r = requests.get(url, headers=headers, timeout=30)
              r.raise_for_status()
              html = r.text

              # If Google serves a bot-check page, it often contains "unusual traffic".
              if "unusual traffic" in html.lower() or "captcha" in html.lower():
                  raise RuntimeError("Google Scholar returned a bot-check/CAPTCHA page.")

              soup = BeautifulSoup(html, "lxml")
              # On Scholar profiles, the citations table has entries like: Citations / All / Since 2019, etc.
              # We grab the first numeric value in the 'Citations' row.
              row = soup.select_one("#gsc_rsb_st tr")
              if not row:
                  raise RuntimeError("Could not find the citations stats table on the page.")

              # Find first integer in that row text.
              m = re.search(r"\b(\d{1,3}(?:,\d{3})*|\d+)\b", row.get_text(" ", strip=True))
              if not m:
                  raise RuntimeError("Could not parse citation number from the stats row.")
              return int(m.group(1).replace(",", ""))

          citations = None
          errors = []

          for fn in (fetch_with_gsbg, fetch_with_html_parse):
              try:
                  citations = fn(profile_url)
                  break
              except Exception as e:
                  errors.append(f"{fn.__name__}: {type(e).__name__}: {e}")

          if citations is None:
              print("FAILED to fetch citations. Errors:")
              for err in errors:
                  print(" -", err)
              sys.exit(1)

          data = {
              "schemaVersion": 1,
              "label": "Citations",
              "message": str(citations),
              "color": "blue"
          }

          with open("scholar-badge.json", "w", encoding="utf-8") as f:
              json.dump(data, f)

          print("SUCCESS. Wrote scholar-badge.json:", data)
          PY

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add scholar-badge.json
          git commit -m "Update Google Scholar citations" || exit 0
          git push
